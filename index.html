<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HDB Resale Prices in Bedok</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* 基本的样式 */
        body {
            font-family: Arial, sans-serif;
        }
        svg {
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h2>Bedok HDB Resale Prices Scatterplot</h2>
    <svg width="800" height="400"></svg>

    <script>
        // 设定图表大小
        const width = 800;
        const height = 400;
        const margin = { top: 20, right: 30, bottom: 50, left: 60 };

        const svg = d3.select("svg")
            .attr("width", width)
            .attr("height", height);

        // 解析时间格式
        const parseDate = d3.timeParse("%Y-%m");

        // 加载数据
        d3.csv("Resale flat prices based on registration date from Jan-2017 onwards.csv").then(data => {
            // 检查加载的数据
            console.log("Loaded data:", data);

            // 数据预处理，只筛选 Bedok 地区的数据
            const filteredData = data.filter(d => d.town === "Bedok");

            // 检查过滤后的数据
            console.log("Filtered Bedok data:", filteredData);

            // 转换数据类型
            filteredData.forEach(d => {
                d.resale_price = +d.resale_price;  // 转售价格为数字
                d.month = parseDate(d.month);      // 时间格式

                // 检查转换后的每条数据
                console.log("Processed data item:", d);
            });

            // 如果过滤后的数据为空，可能是筛选条件不匹配或解析错误
            if (filteredData.length === 0) {
                console.warn("No data found for Bedok in the given timeframe.");
                return;
            }

            // 设定 x 和 y 轴比例尺
            const x = d3.scaleTime()
                .domain(d3.extent(filteredData, d => d.month))
                .range([margin.left, width - margin.right]);

            const y = d3.scaleLinear()
                .domain([0, d3.max(filteredData, d => d.resale_price)]).nice()
                .range([height - margin.bottom, margin.top]);

            // 绘制 x 轴
            svg.append("g")
                .attr("transform", `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(x).ticks(6).tickFormat(d3.timeFormat("%Y-%m")));

            // 绘制 y 轴
            svg.append("g")
                .attr("transform", `translate(${margin.left},0)`)
                .call(d3.axisLeft(y));

            // 绘制散点
            svg.append("g")
                .selectAll("circle")
                .data(filteredData)
                .enter().append("circle")
                .attr("cx", d => x(d.month))
                .attr("cy", d => y(d.resale_price))
                .attr("r", 3)
                .attr("fill", "steelblue")
                .attr("opacity", 0.7);

            // 添加标题和标签
            svg.append("text")
                .attr("x", width / 2)
                .attr("y", height - margin.bottom + 40)
                .attr("text-anchor", "middle")
                .text("Month");

            svg.append("text")
                .attr("x", -height / 2)
                .attr("y", margin.left - 40)
                .attr("transform", "rotate(-90)")
                .attr("text-anchor", "middle")
                .text("Resale Price (SGD)");
        }).catch(error => console.error("Error loading or processing data:", error));
    </script>
</body>
</html>
